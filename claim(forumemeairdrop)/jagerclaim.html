<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jager.meme ç©ºæŠ•é ˜å–å·¥å…· ($JAGER)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            font-size: 12px;
            line-height: 1.5;
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        .container {
            max-width: 800px;
            margin: auto;
            padding: 20px;
            background-color: #2c2c2c;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        h2, h3 {
            margin: 10px 0;
            color: #ffffff;
        }
        input, button {
            width: 100%;
            margin: 5px 0;
            padding: 10px;
            font-size: 12px;
            box-sizing: border-box;
            border: 1px solid #444;
            border-radius: 4px;
            background-color: #333;
            color: #e0e0e0;
        }
        input::placeholder {
            color: #888;
        }
        button {
            background-color: #1e90ff;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #1c86ee;
        }
        .small-button {
            width: auto;
            padding: 5px 10px;
            display: inline-block;
        }
        .flex-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .wallet-list-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #444;
            margin-top: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #444;
            padding: 8px;
            text-align: center;
            font-size: 12px;
            color: #e0e0e0;
        }
        th {
            background-color: #3a3a3a;
        }
        .status {
            font-size: 14px;
            margin-top: 10px;
        }
        .error {
            color: #ff5555;
        }
        .success {
            color: #55ff55;
        }
        .log {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #444;
            padding: 10px;
            background-color: #222;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Jager.meme ç©ºæŠ•é ˜å–å·¥å…· ($JAGER)</h2>
        <h3>å°å…¥éŒ¢åŒ…</h3>
        <div class="flex-row">
            <label for="csvFile">å°å…¥ CSV (.csv)</label>
            <input type="file" id="csvFile" accept=".csv">
            <button class="small-button" onclick="downloadTemplate()">ğŸ“„ ä¸‹è¼‰ç¯„æœ¬</button>
        </div>

        <h3>éŒ¢åŒ…åˆ—è¡¨</h3>
        <div class="flex-row">
            <label><input type="checkbox" id="selectAllWallets" onclick="toggleAllWallets()"> å…¨é¸</label>
            <button class="small-button" onclick="selectWalletsWithAmountGreaterThanOne()">é¸æ“‡é‡‘é¡ > 1</button>
        </div>
        <div class="wallet-list-container">
            <table id="walletTable">
                <thead>
                    <tr>
                        <th>é¸æ“‡</th>
                        <th>éŒ¢åŒ…åœ°å€</th>
                        <th>BNB é¤˜é¡</th>
                        <th>é ˜å–é‡‘é¡</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <h3>äº¤æ˜“è¨­ç½®</h3>
        <input type="text" id="targetAddress" placeholder="ç›®æ¨™åˆç´„åœ°å€" value="0x1fa096b63e347cf9d14ba18f89b8dcccb504cedf">
        <input type="text" id="apiCookie" placeholder="Jager.meme API Cookie (å¯é¸)">
        <div class="flex-row">
            <button class="small-button" onclick="startTransactions()">ğŸš€ é–‹å§‹é ˜å–</button>
            <button class="small-button" onclick="stopTransactions()">â›” åœæ­¢é ˜å–</button>
        </div>

        <h3>ç‹€æ…‹: <span id="status" class="status">å¾…æ©Ÿ</span></h3>
        <div id="log" class="log"></div>
    </div>

    <script>
        const provider = new ethers.providers.JsonRpcProvider('https://bsc-dataseed.binance.org/');
        const FIXED_GAS_PRICE = ethers.utils.parseUnits('1', 'gwei');
        let wallets = [];
        let isRunning = false;

        // ä¸‹è¼‰ CSV ç¯„æœ¬
        function downloadTemplate() {
            const template = 'privateKey\n0xYourPrivateKeyHere';
            const blob = new Blob([template], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'template.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // è™•ç† CSV å°å…¥
        document.getElementById('csvFile').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const lines = e.target.result.split('\n').slice(1); // è·³éæ¨™é ­
                    wallets = [];
                    for (const line of lines) {
                        const [privateKey] = line.split(',').map(s => s.trim());
                        if (!privateKey) continue;

                        // é©—è­‰ç§é‘°
                        let wallet;
                        try {
                            wallet = new ethers.Wallet(privateKey, provider);
                        } catch (error) {
                            logMessage(`ç„¡æ•ˆç§é‘°: ${privateKey.slice(0, 6)}...`, 'error');
                            continue;
                        }

                        // æŸ¥è©¢ BNB é¤˜é¡
                        const bnbBalance = await provider.getBalance(wallet.address);
                        const bnbBalanceEth = ethers.utils.formatEther(bnbBalance);

                        // æŸ¥è©¢é ˜å–è³‡æ ¼
                        let amount = '0';
                        try {
                            const bountyData = await queryBounty(wallet.address);
                            amount = bountyData?.data?.amount || '0';
                        } catch (error) {
                            logMessage(`æŸ¥è©¢é ˜å–è³‡æ ¼å¤±æ•— (${wallet.address}): ${error.message}`, 'error');
                        }

                        wallets.push({ privateKey, address: wallet.address, bnbBalance: bnbBalanceEth, amount });
                    }
                    updateWalletTable();
                    logMessage('âœ… CSV å°å…¥æˆåŠŸ', 'success');
                } catch (error) {
                    logMessage(`CSV å°å…¥å¤±æ•—: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file);
        });

        // æ›´æ–°éŒ¢åŒ…è¡¨æ ¼
        function updateWalletTable() {
            const tableBody = document.getElementById('walletTable').querySelector('tbody');
            tableBody.innerHTML = '';
            wallets.forEach((wallet, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="walletCheckbox" data-index="${index}"></td>
                    <td>${wallet.address}</td>
                    <td>${parseFloat(wallet.bnbBalance).toFixed(4)} BNB</td>
                    <td>${wallet.amount} JAGER</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // å…¨é¸éŒ¢åŒ…
        function toggleAllWallets() {
            const checkboxes = document.querySelectorAll('.walletCheckbox');
            const selectAll = document.getElementById('selectAllWallets').checked;
            checkboxes.forEach(cb => cb.checked = selectAll);
        }

        // é¸æ“‡é ˜å–é‡‘é¡ > 1 çš„éŒ¢åŒ…
        function selectWalletsWithAmountGreaterThanOne() {
            const checkboxes = document.querySelectorAll('.walletCheckbox');
            checkboxes.forEach(cb => {
                const index = cb.dataset.index;
                const wallet = wallets[index];
                cb.checked = parseFloat(wallet.amount) > 1;
            });
            document.getElementById('selectAllWallets').checked = false; // å–æ¶ˆå…¨é¸ç‹€æ…‹
        }

        // æŸ¥è©¢åˆç´„æ˜¯å¦æœ‰æ•ˆ
        async function isValidContract(address) {
            try {
                const code = await provider.getCode(address);
                return code !== '0x' && code !== '0x0';
            } catch (error) {
                logMessage(`æª¢æŸ¥åˆç´„åœ°å€ ${address} å¤±æ•—: ${error.message}`, 'error');
                return false;
            }
        }

        // æ ¼å¼åŒ–åœ°å€
        function formatAddress(address) {
            return '000000000000000000000000' + address.slice(2).toLowerCase();
        }

        // æ ¼å¼åŒ–æ•¸å€¼
        function formatNumber(value, decimals = 0) {
            const hex = ethers.utils.hexlify(ethers.utils.parseUnits(value.toString(), decimals)).slice(2);
            return '0'.repeat(64 - hex.length) + hex;
        }

        // æŸ¥è©¢é ˜å–è³‡æ ¼
        async function queryBounty(address) {
            const apiCookie = document.getElementById('apiCookie').value;
            const headers = {
                'accept': 'application/json, text/plain, */*',
                'user-agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36',
                'content-type': 'application/json'
            };
            if (apiCookie) headers['cookie'] = apiCookie;

            try {
                const response = await fetch(`https://api.jager.meme/api/jagerFour/queryBounty/${address}`, {
                    method: 'GET',
                    headers
                });
                const data = await response.json();
                if (data.code !== 200) throw new Error(data.message || 'API è«‹æ±‚å¤±æ•—');
                if (!data.data || !data.data.amount || !data.data.proof || !Array.isArray(data.data.proof)) {
                    throw new Error('ç„¡æ•ˆçš„ API å›æ‡‰æ ¼å¼');
                }
                return data;
            } catch (error) {
                throw new Error(`æŸ¥è©¢é ˜å–è³‡æ ¼å¤±æ•—: ${error.message}`);
            }
        }

        // ç”Ÿæˆ claim äº¤æ˜“çš„ calldata
        function generateClaimCalldata(amount, proof) {
            const functionSelector = '0x2f52ebb7'; // claim(address,uint256,bytes32[])
            const addressParam = '0'.repeat(64); // å…¨é›¶åœ°å€ï¼Œå‡è¨­ msg.sender
            const amountParam = formatNumber(amount, 18); // å‡è¨­ 18 å€‹å°æ•¸ä½
            const proofLength = formatNumber(proof.length);
            const proofParams = proof.map(p => p.slice(2).toLowerCase()).join('');
            return functionSelector + amountParam + formatNumber(0x40) + proofLength + proofParams;
        }

        // ç™¼é€ claim äº¤æ˜“
        async function sendClaimTransaction(wallet, targetAddress, amount, proof) {
            try {
                const isContract = await isValidContract(targetAddress);
                if (!isContract) throw new Error(`ç„¡æ•ˆåˆç´„åœ°å€: ${targetAddress}`);

                const calldata = generateClaimCalldata(amount, proof);
                const tx = {
                    to: targetAddress,
                    value: 0,
                    data: calldata,
                    gasLimit: 223458, // å›ºå®š gas limit
                    gasPrice: FIXED_GAS_PRICE
                };

                const txResponse = await wallet.sendTransaction(tx);
                logMessage(`Claim äº¤æ˜“ç™¼é€: ${txResponse.hash}`, 'success');
                const receipt = await txResponse.wait();
                logMessage(`Claim äº¤æ˜“ç¢ºèª: å€å¡Š ${receipt.blockNumber}`, 'success');
                return receipt;
            } catch (error) {
                logMessage(`Claim äº¤æ˜“å¤±æ•— (${wallet.address}): ${error.message}`, 'error');
                return null;
            }
        }

        // é–‹å§‹äº¤æ˜“
        async function startTransactions() {
            if (isRunning) return;
            isRunning = true;
            document.getElementById('status').innerText = 'é‹è¡Œä¸­...';

            const selectedWallets = wallets.filter((_, index) => document.querySelector(`.walletCheckbox[data-index="${index}"]`).checked);
            if (selectedWallets.length === 0) {
                logMessage('âš ï¸ è«‹é¸æ“‡è‡³å°‘ä¸€å€‹éŒ¢åŒ…', 'error');
                stopTransactions();
                return;
            }

            const targetAddress = document.getElementById('targetAddress').value;
            if (!ethers.utils.isAddress(targetAddress)) {
                logMessage('âš ï¸ ç„¡æ•ˆç›®æ¨™åˆç´„åœ°å€', 'error');
                stopTransactions();
                return;
            }

            for (const walletData of selectedWallets) {
                if (!isRunning) break;

                const wallet = new ethers.Wallet(walletData.privateKey, provider);
                logMessage(`è™•ç†éŒ¢åŒ…: ${wallet.address}`, 'success');

                // é©—è­‰ BNB é¤˜é¡
                const bnbBalance = await provider.getBalance(wallet.address);
                const bnbBalanceEth = ethers.utils.formatEther(bnbBalance);
                if (parseFloat(bnbBalanceEth) < 0.001) {
                    logMessage(`éŒ¢åŒ… ${wallet.address} BNB é¤˜é¡ä¸è¶³: ${bnbBalanceEth} < 0.001`, 'error');
                    continue;
                }

                // æŸ¥è©¢é ˜å–è³‡æ ¼
                let bountyData;
                try {
                    bountyData = await queryBounty(wallet.address);
                    if (!bountyData.data.amount || bountyData.data.amount === '0') {
                        logMessage(`éŒ¢åŒ… ${wallet.address} ç„¡é ˜å–è³‡æ ¼`, 'error');
                        continue;
                    }
                } catch (error) {
                    logMessage(`æŸ¥è©¢é ˜å–è³‡æ ¼å¤±æ•— (${wallet.address}): ${error.message}`, 'error');
                    continue;
                }

                // ç™¼é€ claim äº¤æ˜“
                const receipt = await sendClaimTransaction(wallet, targetAddress, bountyData.data.amount, bountyData.data.proof);
                if (receipt) {
                    logMessage(`éŒ¢åŒ… ${wallet.address} é ˜å–å®Œæˆ`, 'success');
                }
            }

            stopTransactions();
        }

        // åœæ­¢äº¤æ˜“
        function stopTransactions() {
            isRunning = false;
            document.getElementById('status').innerText = 'å·²æš«åœ';
            logMessage('äº¤æ˜“å·²åœæ­¢', 'success');
        }

        // æ—¥èªŒè¼¸å‡º
        function logMessage(message, type = '') {
            const logDiv = document.getElementById('log');
            const p = document.createElement('p');
            p.className = type;
            p.innerText = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(p);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
    </script>
</body>
</html>